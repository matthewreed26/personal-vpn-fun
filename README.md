# personal-vpn-fun

This README documents the process of configuring a macOS MacBook Pro to act as a secure Wi-Fi hotspot, sharing its internet connection which is tunneled through an OpenVPN client (specifically to a self-hosted OpenVPN server on an ASUS router). This guide also covers common troubleshooting steps, particularly for DNS and MTU issues.

## Project Goal

The primary goal was to create a portable, secure Wi-Fi hotspot using a MacBook Pro, where all connected client devices (like a smartphone or personal laptop) would have their internet traffic routed through an OpenVPN tunnel established on the MacBook. This is particularly useful for securing devices on untrusted public Wi-Fi networks (e.g., coffee shops, hotels).

## Hardware and Software Involved

- **MacBook Pro (Host):** Running macOS (version used during troubleshooting).
- **OpenVPN Client:** Tunnelblick (macOS client for OpenVPN).
- **OpenVPN Server:** ASUS router acting as an OpenVPN server.
- **`dnsmasq`** (a lightweight DNS forwarder and DHCP server).

## Section 1: Initial Setup - MacBook Pro as VPN Client

The first step is to ensure the MacBook Pro itself can connect to your OpenVPN server and route all its internet traffic through the VPN.

1. **Configure ASUS Router as OpenVPN Server:**

   - Ensure your ASUS router is correctly configured as an OpenVPN server. This typically involves port forwarding (UDP 1194 by default), setting up user accounts, and exporting the `.ovpn` client configuration file.
   - **Crucial ASUS Router OpenVPN Server Settings (Advanced Settings Page):**
     - **"Direct clients to redirect Internet traffic"**: Set this to **No**.
       - **Explanation:** This stops the router from pushing its own `redirect-gateway` directive (and potentially conflicting `redirect-private` directives) to your client. You want your `.ovpn` file to solely control the full tunnel.
     - **"Advertise DNS to clients"**: Set this to **No**.
       - **Explanation:** This prevents the router from pushing its own DNS server addresses (and problematic options like `block-outside-dns`) to the client. Your `.ovpn` file and `dnsmasq` will handle DNS explicitly.
     - **"Push LAN to clients"**: This depends on your preference.
       - Set to **Yes** if you want VPN clients to access devices on your home LAN (e.g., NAS, other computers) while connected to the VPN.
       - Set to **No** if you only want internet traffic through the VPN and no access to your home LAN via the tunnel.
     - **MSS Clamping (Recommended):** If your ASUS router's OpenVPN server settings allow it, ensure it's configured to perform MSS clamping (e.g., a `mssfix` directive on the server side). While we'll add it to the client, it's ideal for the server to handle this.
     - **Compression (For Performance)**: Set to Disabled or None as it adds unnecessary overhead.

2. **Prepare OpenVPN Client (`.ovpn`) File for Tunnelblick:**

   - Download the `.ovpn` file generated by your ASUS router.
   - **Important Modifications to `.ovpn` file:**

     - **Full Tunneling:** Ensure the client is configured to route _all_ traffic through the VPN. Add (or confirm presence of) this line:

       ```system
       redirect-gateway def1
       ```

     - **Force Public DNS Servers:** Override any DNS servers pushed by the VPN server (which might be local LAN IPs, unreachable via the tunnel) and force use of public, VPN-routable DNS. Add these lines:

       ```system
       dhcp-option DNS 1.1.1.1
       dhcp-option DNS 8.8.8.8
       ```

     - **MSS Clamping (Crucial for Web Browse):** This is vital to prevent packet fragmentation issues, especially across multiple NAT/VPN layers. Add this line:

       ```system
       mssfix 1300
       ```

       (Start with `1300` as a safe value; you can try `1400` later if successful).

     - **Replay Protection Tolerance:** To prevent "Authenticate/Decrypt packet error: bad packet ID (may be a replay)" warnings, add this line:

       ```system
       replay-window 512 60
       ```

       - **Explanation:** This increases the window of acceptable packet IDs (to 512) and the time (to 60 seconds) that a packet ID remains valid, making the connection more tolerant of network latency, packet reordering, and delays common on unstable networks.

     - **Compression (For Performance):** To reduce overhead, comment out any lines like the following:

       ```system
       # for OpenVPN 2.4 or older
       ;comp-lzo yes
       # for OpenVPN 2.4 or newer
       ;compress lzo
       ```

     - **Buffer Sizes and Fast I/O (For Performance):** To potentially improve throughput, especially on high-latency links, add these lines:

       ```system
       sndbuf 524288
       rcvbuf 524288
       fast-io
       ```

       - **Explanation:**
         - `sndbuf` and `rcvbuf` increase the send and receive buffer sizes respectively, allowing more data to be in transit, which can help with throughput on connections with higher latency.
         - `fast-io` is a client-side optimization that allows OpenVPN to perform reads and writes to the tunnel device more efficiently, reducing latency and potentially increasing throughput.

3. **Install and Configure Tunnelblick:**

   - Download and install Tunnelblick on your MacBook Pro.
   - Import the modified `.ovpn` file into Tunnelblick.
   - Connect the VPN in Tunnelblick.

4. **Verify MacBook Pro's Internet:**
   - Open a web browser on your MacBook Pro and verify you can access websites.
   - Check your public IP address (e.g., `whatismyip.com`) to confirm it's the IP of your home router's WAN or your VPN provider's exit IP, indicating traffic is routed through the VPN.
   - In Terminal, run `scutil --dns` to confirm the MacBook's DNS servers are showing `1.1.1.1` and `8.8.8.8` (or your chosen public DNS).

## Section 2: Initial Setup - MacBook Pro Internet Sharing

Next, configure the MacBook Pro to share its internet connection as a Wi-Fi hotspot.

1. **Configure Internet Sharing:**

   1. Go to **System Settings** > **General** > **Sharing**.
   1. Enable **Internet Sharing**.
   1. In the "Share your connection from" dropdown, select the **Wi-Fi or Ethernet interface**
   1. In the "To computers using" section, select **Wi-Fi or Ethernet**. If Wi-Fi, click **Wi-Fi Options...** to set a Network Name (SSID) and a strong password for your shared Wi-Fi network.
   1. **Turn On** to enable Internet Sharing.
   1. MacOS will automatically create a bridged network interface (often `bridge100`) and assign it an IP address (e.g., `192.168.2.1`) which will act as the DHCP server and default gateway for connected clients.

2. **Run enable script for NAT Packet Forwarding**

   - Since MacOS will not route traffic through the Tunnelblick VPN by default, NAT and packet forwarding are necessary
   - Using this script, make it executable (`chmod +x enable-vpn-traffic-forwarding.sh`), and run it:

     ```bash
     sudo ./enable-vpn-traffic-forwarding.sh
     ```

   - **Note:** These `pf` rules might need to be re-applied after a reboot or if Internet Sharing is toggled off/on. You can verify `pf` rules with `sudo pfctl -s nat` and `sudo pfctl -s rules`.

3. **Configure `dnsmasq` for DNS Forwarding (Crucial for DNS):**

   - While macOS's built-in Internet Sharing handles DHCP, it doesn't always perfectly integrate DNS forwarding, especially with a dynamic VPN interface.
   - By using `dnsmasq`, you explicitly control which DNS servers are used by clients connected to your shared Wi-Fi. `dnsmasq` runs on your MacBook and acts as the DNS server for the `192.168.2.x` network provided by Internet Sharing. It then forwards those requests through your VPN tunnel.
   - **Ensure `dnsmasq` is installed and running.** If you installed it via Homebrew, you can typically start it with `brew services start dnsmasq`.
   - **Edit your `dnsmasq.conf` file** (commonly located at `/opt/homebrew/etc/dnsmasq.conf` or `/usr/local/etc/dnsmasq.conf` if installed via Homebrew). Ensure it contains (or uncomment/add) these essential lines:

     ```system
     # Do NOT read /etc/resolv.conf. We will specify our own upstream servers.
     no-resolv
     # Explanation: Prevents dnsmasq from automatically reading DNS servers from /etc/resolv.conf.
     # This is crucial because /etc/resolv.conf can be dynamically updated by your VPN client (Tunnelblick)
     # or by your upstream internet connection, and we want dnsmasq to ONLY use the specific
     # public DNS servers (1.1.1.1, 8.8.8.8) that we explicitly configure, ensuring they go via the VPN.

     # Specify the upstream DNS servers to use (these will be routed through your VPN)
     server=1.1.1.1
     server=8.8.8.8
     # Explanation: These lines explicitly tell dnsmasq where to forward DNS queries it receives.
     # Since your MacBook's OpenVPN configuration (`redirect-gateway def1`) routes all internet-bound
     # traffic through the VPN, these queries to 1.1.1.1 and 8.8.8.8 will also go via the VPN tunnel,
     # ensuring DNS privacy and preventing leaks.

     # Ensure that non-fully qualified domain names (like "myserver" instead of "myserver.local") are
     # only forwarded to upstream DNS servers that are configured to handle them (i.e., not public DNS).
     # This helps prevent leaking internal network queries to external DNS servers.
     domain-needed
     # Explanation: This option instructs dnsmasq to never forward A or AAAA (IPv4/IPv6 address) queries
     # for plain names, without dots or domain parts, to upstream DNS servers. For example, if a client
     # tries to resolve "myprinter", dnsmasq will not send this query to 1.1.1.1. This is good practice
     # to keep internal network queries from potentially leaking to public DNS.

     # Do not forward reverse lookups for private IP ranges to upstream DNS servers.
     bogus-priv
     # Explanation: This option tells dnsmasq to not forward reverse DNS lookups (PTR queries) for
     # private IP ranges (e.g., 10.0.0.0/8, 192.168.0.0/16) to upstream DNS servers. These lookups
     # are typically for devices on local networks and would fail or leak information if sent externally.
     # For example, if a client tries to resolve "192.168.1.5", dnsmasq will not send this query to 1.1.1.1.

     # Do not poll /etc/resolv.conf for changes.
     no-poll
     # Explanation: Similar to `no-resolv`, this prevents dnsmasq from monitoring /etc/resolv.conf
     # for changes. This ensures dnsmasq remains stable using your explicitly configured `server=` lines,
     # even if macOS's resolv.conf file is modified by the VPN client or other network changes.

     # Bind only to the interfaces it is listening on. This is generally good security practice.
     bind-interfaces
     # Explanation: This option forces dnsmasq to bind only to the network interfaces specified by
     # `listen-address` directives. Without it, dnsmasq might bind to all available interfaces,
     # which can sometimes lead to unexpected behavior or security issues, especially in a dynamic
     # setup like Internet Sharing. It ensures dnsmasq is only active on the interfaces it's meant to serve.

     # Do not read /etc/hosts (or equivalent) for host names.
     no-hosts
     # Explanation: This prevents dnsmasq from using entries in your MacBook's /etc/hosts file for DNS resolution.
     # This ensures that all DNS resolution (except for specific overrides you might add within dnsmasq.conf itself)
     # goes through your specified upstream DNS servers (1.1.1.1, 8.8.8.8), helping to maintain consistency
     # and prevent local host file entries from affecting shared clients.

     # Listen only on the bridge100 interface (or the interface Internet Sharing creates for the hotspot)
     # Find the IP of bridge100 after Internet Sharing is enabled using `ifconfig bridge100`
     # Replace 192.168.2.1 with the actual IP if it's different.
     listen-address=192.168.2.1

     # Or, if you want it to listen on all interfaces (less secure but might work for testing)
     # listen-address=0.0.0.0
     # bind-interfaces # (Note: If using 0.0.0.0 with bind-interfaces, dnsmasq will bind to all available interfaces' IPs)

     # Optional: Log DNS queries for debugging
     # log-queries
     ```

## Section 3: Troubleshooting and Validation

This section covers the iterative troubleshooting process for common issues.

1. **Verify IP and DNS on Client Device:**

   - On the client device, confirm it connects to the internet and received an IP address from the MacBook's DHCP (e.g., `192.168.2.x`) and that `192.168.2.1` is listed as its DNS server.

2. **Test Internet Connectivity Debugging:**

   - **MTU/MSS Diagnosis and Potential Fix:**
     - **Observation:** The `utunX` (VPN) interface on the MacBook had an `mtu` of `1500`.
     - **Reasoning:** OpenVPN adds headers, so a 1500-byte packet plus VPN headers becomes larger than 1500 bytes, leading to fragmentation or drops on the internet.
     - **Solution:** Added `mssfix 1300` to the `.ovpn` client configuration file.
     - **Validation:** After implementing `mssfix`, direct IP Browse (`http://142.250.191.46`) and general web Browse **should now work** on personal devices.
